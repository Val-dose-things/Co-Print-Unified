###################################

#ADD TO printer.cfg #[include CoPrint_UnifiedMacro.cfg] 

### UPDATE AS NEEDED###

[gcode_macro _global_var]
variable_pause_park:{'x': 10, 'y': 10, 'z': 10, 'e': 1}
variable_cancel_park:{'x': 10, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 344
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 65
variable_load_filament_extruder_temp: 250
variable_retract_length: 20
variable_extruder_move_speed: 50
gcode:

[idle_timeout]
gcode: _IDLE_TIMEOUT
timeout: 3600 ; IN SECONDS DEFAULT IS 1 HOUR

[include chroma_head.cfg]
[include kcm.cfg]

#[include driver.cfg
#[include ecm_1.cfg
#[include ecm_2.cfg
#[include ecm_3.cfg
#[include ecm_4.cfg

############################

## only on mainline klipper ## ; the error: mcu 'cp_Head': Command format mismatch: query_adxl345 oid=%c clock=%u rest_ticks=%u vs query_adxl345 oid=%c rest_ticks=%u

############################

#[include chroma_head_input_shaper.cfg]

### for the accelerometer pcb ####

#[include external_inputshaper.cfg]
#[include BTT_LIS2DW_input_shaper.cfg]

[gcode_macro GANTRY_LEVELING]
gcode:
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int if printer.heater_bed.target<10 else printer.heater_bed.target|int %}
    {% set current_target_temp  = printer.heater_bed.target|int %}

    {action_respond_info("Check Heating!")}
    {% if printer.heater_bed.temperature != mesh_calibrate_temp %}
        M140 S{mesh_calibrate_temp}
        {action_respond_info("The bed target temperature was not reached!")}
        {action_respond_info("Bed heating...")}
        M190 S{mesh_calibrate_temp}
    {% endif %}

    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}
    
    ##### IF NEEDED PLEASE UNCOMMENT. LEAVE AS IS IF NOT. #### 
	
    #z_tilt ;Multiple Z stepper tilt adjustment. https://www.klipper3d.org/Config_Reference.html#z_tilt
    #QUAD_GANTRY_LEVEL ;Moving gantry leveling using 4 independently controlled Z motors. https://www.klipper3d.org/Config_Reference.html?h=quad#quad_gantry_level
    
	#####################################
	
    {% if current_target_temp == 0 %}
        M140 S0
    {% endif %}

#--------------------------------------------------------------------#
#### SHOULD NOT NEED TO UPDATE #####
#--------------------------------------------------------------------#


[gcode_macro FILAMENT_CHANGE] # FILAMENT_CHANGE LAYER_NUM=[layer_num] NEXT_EXTRUDER=[next_extruder]
gcode:
    {% set LAYER_NUM = params.LAYER_NUM|int %}
    {% set NEXT_EXTRUDER = params.NEXT_EXTRUDER|int %}
    {% if LAYER_NUM == -1 %}
    {% endif %}
    {% if LAYER_NUM != -1 %}
    
    M117 FILAMENT_CHANGE at LAYER {LAYER_NUM}
    M118 FILAMENT_CHANGE at LAYER {LAYER_NUM}
    G90
	CUT_UNLOAD_FILAMENT
    T{NEXT_EXTRUDER}
	CUT_LOAD_FILAMENT
    {% endif %}
	
[gcode_macro M600]
gcode:
    FILAMENT_CHANGE

[gcode_macro CUT_UNLOAD_FILAMENT]
gcode:
    {% set retract_length = printer['gcode_macro _global_var'].retract_length|float %}
    {% set extruder_move_speed = printer['gcode_macro _global_var'].extruder_move_speed|float %}

    G90 # Absolute positioning
    M83 # Relative extrusion
    G92 E0
    G1 E-{retract_length} F{extruder_move_speed * 60}
    FILAMENT_CUT
    G1 E-{retract_length * 3} F{extruder_move_speed * 60}

[gcode_macro CUT_LOAD_FILAMENT]
gcode:
    {% set retract_length = printer['gcode_macro _global_var'].retract_length|float %}
    {% set extruder_move_speed = printer['gcode_macro _global_var'].extruder_move_speed|float %}

    G90 # Absolute positioning
    M83 # Relative extrusion
    G92 E0
    G1 E{retract_length * 3} F{extruder_move_speed * 60}
	G1 E{retract_length} F{extruder_move_speed * 30}
	
[force_move]
enable_force_move: True

[gcode_macro _IDLE_TIMEOUT]
gcode:
    {% if printer.print_stats.state == "paused" %}
      RESPOND TYPE=echo MSG="No operations in 10min!"
    {% else %}
     M84
     TURN_OFF_HEATERS
    {% endif %}


[gcode_macro _ALL_FAN_OFF]
gcode:
    M106 S0
    M107

[gcode_macro Hotend_PID]
gcode:
  PID_CALIBRATE HEATER=extruder TARGET=235
  SAVE_CONFIG
    
[gcode_macro Bed_PID]
gcode:
  PID_CALIBRATE HEATER=heater_bed TARGET=65
  SAVE_CONFIG

[gcode_macro HEATSOAK]
gcode:
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int if printer.heater_bed.target<10 else printer.heater_bed.target|int %}

    M190 S{mesh_calibrate_temp}
    M400
    M117 heat soaking 5 minutes!
    M118 heat soaking 5 minutes!
    G4 P300000
    M400
    M117 heat soaking completed!
    M118 heat soaking completed!

[gcode_macro AUTO_BED_MESH_CALIBRATE]
gcode:

    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}
    HEATSOAK
    GANTRY_LEVELING
    BED_MESH_CALIBRATE 
    M140 S0
    
[gcode_macro one_click_setup]
gcode: 
    M117 Tune Hotend PID
    PID_CALIBRATE HEATER=extruder TARGET=235
    M117 Tune Hotbed PID
    PID_CALIBRATE HEATER=heater_bed TARGET=65
    M117 Z OFFSET
    PROBE_CALIBRATE
    M117 Bed Mesh
    GANTRY_LEVELING
    BED_MESH_CALIBRATE

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BED_MESH_CALIBRATE_BASE
gcode:
    
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int if printer.heater_bed.target<10 else printer.heater_bed.target|int %}
    {% set current_target_temp  = printer.heater_bed.target|int %}

    {action_respond_info("Check Heating!")}
    {% if printer.heater_bed.temperature != mesh_calibrate_temp %}
        M140 S{mesh_calibrate_temp}
        {action_respond_info("The bed target temperature was not reached!")}
        {action_respond_info("Bed heating...")}
        M190 S{mesh_calibrate_temp}
    {% endif %}

    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}
    
    BED_MESH_CLEAR
	
    BED_MESH_CALIBRATE_BASE ADAPTIVE=1

    {% if current_target_temp == 0 %}
        M140 S0  
    {% endif %}

[delayed_gcode _print_start_wait]
gcode:
    {% if printer['gcode_macro START_PRINT'].state == 'Heating'%}
        {action_respond_info("Prepare->Heating!")}
    {% elif printer['gcode_macro START_PRINT'].state == 'Start' %}
        {action_respond_info("Heating->Start!")}
    {% endif %}
    {% if printer['gcode_macro START_PRINT'].execute|lower != 'false' %}
        START_PRINT
    {% endif %}

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if printer.pause_resume.is_paused == False %}
        {% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
        {% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
        {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
        {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}

        {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
        
        {action_respond_info("Pause Print!")}
        
        PAUSE_BASE
        M117 Pause Print!!!
        G91
        {% if (printer.gcode_move.position.z + 5) < z_lift_max %}
            G1 Z+5 F3000
        {% else %}
            G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
        {% endif %}
        G90
        {% if printer.gcode_move.position.x != x_park and
                printer.gcode_move.position.y != y_park     
        %}
            G1 X{x_park} Y{y_park} F{printer["gcode_macro _global_var"].pause_resume_travel_speed * 60}
        {% endif %}

        M104 S{printer.extruder.target}
    
        {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E+95 F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-50 F300 
                G90
            {% endif %}
        {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E+25 F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-50 F300 
                G90
            {% endif %}
        {% endif %}
    {% endif %}

[delayed_gcode _resume_wait]
gcode:
    {% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
        RESUME
    {% endif %}
    

[gcode_macro RESUME]
description: Pause the actual running print
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}

    {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
        {% if printer.extruder.temperature + 5 >= printer.extruder.target %}
            G91
            G1 E30 F300
            G1 E10 F150
            G90
        {% else %}
            M140 S{extruder_target_temp}
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M190 S{extruder_target_temp}
            G91
            G1 E30 F300
            G1 E10 F150
            G90
        {% endif %}
        {action_respond_info("Print resumming!")}
        RESUME_BASE
    {% if state == 'normal' %}
            {action_respond_info("Print resumming!")}
            G91
            G1 E{e_restract} F300
            G90
            M117 Printing now!!!
            RESUME_BASE
    {% endif %}



[gcode_macro START_PRINT]
description: 
variable_state: 'Prepare'
variable_record_extruder_temp:0
variable_max_record_extruder_temp:0

gcode:
    {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int if printer.heater_bed.target<10 else printer.heater_bed.target|int %}
    {% set extruder_target_temp = printer.extruder.target|int %}
    {% set bed_targe_temp = printer.heater_bed.target|int %}
    M400
  
    CLEAR_PAUSE

    G90
    {% if state == 'Prepare' %}

        {action_respond_info("Prepare!")}

        {% if printer.toolhead.homed_axes|lower != "xyz" %}
            G28
        {% endif %}
        {action_respond_info("Check Heating!")}

        M140 S{bed_targe_temp}
        M104 S{extruder_target_temp}
        
        {% if printer.heater_bed.temperature < bed_targe_temp %}
            M117 Bed heating...
            {action_respond_info("Bed heating...")}
            M190 S{bed_targe_temp}
        {% endif %}

        {% if printer.extruder.temperature < extruder_target_temp %}
            M117 Nozzle heating...
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_target_temp} 
        {% endif %}
        
        {% if printer.quad_gantry_level.applied|lower != 'true' %}
            HEATSOAK
            GANTRY_LEVELING
        {% endif %}
        BED_MESH_CALIBRATE ADAPTIVE=1 
        T{EXTRUDER}

        SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Start"' 
        UPDATE_DELAYED_GCODE ID=_print_start_wait DURATION=0.5

    {% elif state == 'Start' %}
        M117 Printing now!!!
        {action_respond_info("Start!")}
    {% endif %}

[gcode_macro END_PRINT]
description: 
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0  
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

    M117 Finish Print!!!
    G90
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp
        %}
            G1 E-2 F2700
            G1 E-2 Z0.2 F2400
        {% endif %}

    {% if (printer.gcode_move.position.z + 10) < z_max %}
        G1 Z+5 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    
    CUT_UNLOAD_FILAMENT
 
    G90
    G1 X2 Y355 F9000

    _ALL_FAN_OFF
    TURN_OFF_HEATERS

    M84

    M220 S100
    M221 S100

    CLEAR_PAUSE

    {action_respond_info("Finish Print!")}


[gcode_macro CANCEL_PRINT]
description: 
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
    {% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
    {% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE

    M117 Cancel Print!!!
    G90
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp
        %}
            G1 E-{e_restract} F500
        {% else %}
            {action_respond_info("Nozzle not hot enough")}
        {% endif %}

    {%if (printer.gcode_move.position.z + 10) < z_lift_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X{x_park} Y{y_park} F3000
    
    CUT_UNLOAD_FILAMENT
    
    TURN_OFF_HEATERS
    _ALL_FAN_OFF

    CLEAR_PAUSE
    M84

    M117 Ready
    {action_respond_info("Cancel Print Success!")}
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0  
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0
    
[gcode_macro Reset_after_power_off]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Retracting...
        G90

        CUT_UNLOAD_FILAMENT
	
        M400
        M117 Retract Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Retracting...
        G90
        G1 E+5 F300
        G1 E-5 F1000

	CUT_UNLOAD_FILAMENT

        G90
        M400
        M117 Retract Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro FULL_UNLOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Retracting...
        G91
        G1 E+10 F300

	CUT_UNLOAD_FILAMENT
        G1 E-{retract_length * 35} F{extruder_move_speed * 60}

        M400
        M117 Retract Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Extruding...
        G91 

        CUT_LOAD_FILAMENT

        G90
        M400
        M117 Extrude Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}
